<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BuildPilot - Agentic MVP Generator</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
<!-- three.js library for 3D animation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<style>
    body {
        margin: 0;
        background: #000; /* Black background for the space theme */
        min-height: 100vh;
        color: white;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        position: relative;
        overflow-x: hidden; /* Hide horizontal scrollbars */
    }

    #bg-canvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: -1;
    }
    
    .navbar {
        background: rgba(13, 13, 13, 0.5) !important;
        backdrop-filter: blur(5px);
        border-bottom: 1px solid #333;
    }

    .container {
        max-width: 900px;
        position: relative;
        z-index: 1; /* Ensure UI is above the canvas */
    }
    
    .card {
        margin-bottom: 1.5rem;
        background: rgba(13, 13, 13, 0.9);
        border: 1px solid #333;
        border-radius: 12px;
        color: white;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
    }
    
    .card-header {
        font-weight: 600;
        background: rgba(33, 37, 41, 0.8);
        border-bottom: 1px solid #444;
        border-radius: 12px 12px 0 0 !important;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .spinner-border {
        width: 1.2rem;
        height: 1.2rem;
    }
    
    .content-area {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-size: 1rem;
        line-height: 1.6;
        color: #ddd;
        max-height: 600px;
        overflow-y: auto;
        scroll-behavior: smooth;
        white-space: pre-wrap;
    }
    
    .content-area h1, .content-area h2, .content-area h3 {
        color: #8c73ff;
        margin-top: 1.5rem;
        margin-bottom: 0.8rem;
    }
    
    .content-area h1 { font-size: 1.5rem; }
    .content-area h2 { font-size: 1.3rem; }
    .content-area h3 { font-size: 1.1rem; }
    
    .content-area ul, .content-area ol {
        margin-left: 1.2rem;
        margin-bottom: 1rem;
    }
    
    .content-area li {
        margin-bottom: 0.4rem;
    }
    
    .content-area pre {
        background: rgba(0, 0, 0, 0.6);
        border: 1px solid #444;
        border-radius: 6px;
        padding: 1rem;
        overflow-x: auto;
        margin: 1rem 0;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    }
    
    .content-area code {
        background: rgba(0, 0, 0, 0.4);
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    }
    
    .content-area pre code {
        background: none;
        padding: 0;
    }
    
    .content-area strong {
        color: #ffcc00;
        font-weight: 600;
    }
    
    .btn-primary {
        background: linear-gradient(45deg, #00c6ff, #0072ff);
        border: none;
        padding: 0.6rem 2rem;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 198, 255, 0.3);
    }
    
    .btn-primary:disabled {
        background: #6c757d;
        transform: none;
        box-shadow: none;
    }
    
    .form-control {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid #495057;
        color: white;
        border-radius: 8px;
    }
    
    .form-control:focus {
        background: rgba(255, 255, 255, 0.15);
        border-color: #00c6ff;
        color: white;
        box-shadow: 0 0 0 0.25rem rgba(0, 198, 255, 0.25);
    }
    
    .form-control::placeholder {
        color: #adb5bd;
    }
    
    .display-4 {
        background: linear-gradient(45deg, #00c6ff, #8c73ff, #ffcc00);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .step-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 8px;
        transition: all 0.3s ease;
    }
    
    .step-indicator.pending { background: #6c757d; }
    .step-indicator.active { background: #8c73ff; animation: pulse 1.5s infinite; }
    .step-indicator.complete { background: #00ff99; }
    
    .typing-text {
        position: relative;
        display: inline;
    }
    
    .typing-text::after {
        content: '|';
        animation: blink 0.7s infinite;
        color: #ddd;
        font-weight: bold;
        margin-left: 2px;
    }
</style>
</head>
<body>
<canvas id="bg-canvas"></canvas>
<nav class="navbar navbar-expand-lg navbar-dark bg-transparent">
    <div class="container">
        <a class="navbar-brand" href="/">BuildPilot</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="/">Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/about">About</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/contact">Contact</a>
                </li>
            </ul>
        </div>
    </div>
</nav>
<div class="container py-5">
    <div class="text-center mb-5">
        <h1 class="display-4">ðŸš€ BuildPilot</h1>
        <p class="lead">Autonomous MVP Generation</p>
    </div>

    <div class="card">
        <div class="card-body">
            <form id="idea-form">
                <div class="mb-3">
                    <label for="idea-input" class="form-label">Enter your product idea:</label>
                    <input type="text" class="form-control" id="idea-input" placeholder="e.g., 'Trello for Students' or 'AI Note Summarizer'">
                </div>
                <button type="submit" class="btn btn-primary">Generate MVP</button>
            </form>
        </div>
    </div>
    
    <div id="status-container" class="mt-3"></div>

    <div id="result-container" class="mt-5">
        <div class="card" id="research-card" style="display: none;">
            <div class="card-header">
                <span><span class="step-indicator pending" id="research-indicator"></span>Market Research</span>
                <div class="spinner-border text-primary" role="status" id="research-spinner" style="display: none;"></div>
            </div>
            <div class="card-body content-area" id="research-output"></div>
        </div>
        
        <div class="card" id="features-card" style="display: none;">
            <div class="card-header">
                <span><span class="step-indicator pending" id="features-indicator"></span>Feature Plan</span>
                <div class="spinner-border text-primary" role="status" id="features-spinner" style="display: none;"></div>
            </div>
            <div class="card-body content-area" id="features-output"></div>
        </div>
        
        <div class="card" id="code-card" style="display: none;">
            <div class="card-header">
                <span><span class="step-indicator pending" id="code-indicator"></span>Generated Code</span>
                <div class="spinner-border text-primary" role="status" id="code-spinner" style="display: none;"></div>
            </div>
            <div class="card-body content-area" id="code-output"></div>
        </div>
        
        <div class="card" id="review-card" style="display: none;">
            <div class="card-header">
                <span><span class="step-indicator pending" id="review-indicator"></span>Code Review</span>
                <div class="spinner-border text-primary" role="status" id="review-spinner" style="display: none;"></div>
            </div>
            <div class="card-body content-area" id="review-output"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // === Three.js Background Animation ===
    let scene, camera, renderer, stars = [];
    let isAnimating = false;

    // Function to create a moving starfield
    function createStars() {
        const starGeometry = new THREE.SphereGeometry(0.05, 24, 24);
        const starMaterial = new THREE.MeshBasicMaterial({ color: 0xffffff });
        for (let i = 0; i < 2000; i++) {
            const star = new THREE.Mesh(starGeometry, starMaterial);
            star.position.x = (Math.random() - 0.5) * 200;
            star.position.y = (Math.random() - 0.5) * 200;
            star.position.z = (Math.random() - 0.5) * 200;
            star.velocity = new THREE.Vector3(
                (Math.random() - 0.5) * 0.05,
                (Math.random() - 0.5) * 0.05,
                (Math.random() - 0.5) * 0.05
            );
            scene.add(star);
            stars.push(star);
        }
    }

    function initBackground() {
        // Scene setup
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('bg-canvas'), antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);

        // Add ambient light
        scene.add(new THREE.AmbientLight(0xffffff, 0.5));
        
        // Add point light
        const pointLight = new THREE.PointLight(0xffffff, 1);
        pointLight.position.set(0, 0, 0);
        scene.add(pointLight);

        // Call the function to create the stars
        createStars();

        camera.position.z = 15;

        // Handle window resizing
        window.addEventListener('resize', () => {
            const width = window.innerWidth;
            const height = window.innerHeight;
            renderer.setSize(width, height);
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
        });
    }

    // Animation loop
    function animate() {
        if (!isAnimating) return;
        requestAnimationFrame(animate);

        // Animate stars to move in all directions
        const boundary = 100;
        stars.forEach(star => {
            star.position.add(star.velocity);
            
            if (star.position.x > boundary || star.position.x < -boundary) star.position.x = -star.position.x;
            if (star.position.y > boundary || star.position.y < -boundary) star.position.y = -star.position.y;
            if (star.position.z > boundary || star.position.z < -boundary) star.position.z = -star.position.z;
        });

        renderer.render(scene, camera);
    }

    function startBackgroundAnimation() {
        if (!isAnimating) {
            isAnimating = true;
            animate();
        }
    }
    
    // === Main App Logic ===
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize the 3D background and start the animation immediately
        initBackground();
        startBackgroundAnimation();

        const form = document.getElementById('idea-form');
        const ideaInput = document.getElementById('idea-input');
        const submitButton = document.querySelector('button[type="submit"]');
        const statusContainer = document.getElementById('status-container');

        const steps = ['research', 'features', 'code', 'review'];
        const elements = {};
        const stepContent = {};
        
        steps.forEach(step => {
            elements[step] = {
                card: document.getElementById(`${step}-card`),
                spinner: document.getElementById(`${step}-spinner`),
                output: document.getElementById(`${step}-output`),
                indicator: document.getElementById(`${step}-indicator`)
            };
            stepContent[step] = '';
        });

        function resetUI() {
            steps.forEach(step => {
                elements[step].card.style.display = 'none';
                elements[step].spinner.style.display = 'none';
                elements[step].output.innerHTML = '';
                elements[step].indicator.className = 'step-indicator pending';
                stepContent[step] = '';
            });
            document.querySelectorAll('.alert').forEach(alert => alert.remove());
            statusContainer.innerHTML = '';
            
            // Do not stop the background animation on reset
        }

        function showStep(step) {
            elements[step].card.style.display = 'block';
            elements[step].indicator.className = 'step-indicator active';
            elements[step].spinner.style.display = 'inline-block';
            elements[step].output.innerHTML = '<span class="typing-text"></span>';
        }
        
        // A single, vibrant color for the text
        const textColor = '#00ffff'; 

        // Function to scroll the main window to the bottom smoothly
        function scrollToBottom() {
            window.scrollTo({
                top: document.body.scrollHeight,
                behavior: 'smooth'
            });
        }

        function appendText(step, textChunk) {
            const typingSpan = elements[step].output.querySelector('.typing-text');
            if (typingSpan) {
                // Split the chunk into words and bold the first two
                const words = textChunk.split(' ');
                const firstTwoWords = words.splice(0, 2).join(' ');
                
                const boldSpan = document.createElement('strong');
                boldSpan.textContent = firstTwoWords;
                boldSpan.style.color = '#ffcc00'; // Unique color for bolded keywords
                typingSpan.before(boldSpan);

                const remainingText = words.join(' ');
                for (const char of remainingText) {
                    const span = document.createElement('span');
                    span.textContent = char;
                    span.style.color = textColor; // Use the single color for the rest of the text
                    typingSpan.before(span);
                }
                
                // Scroll both the content area and the main window
                elements[step].output.scrollTop = elements[step].output.scrollHeight;
                scrollToBottom();
            }
        }

        function completeStep(step, finalContent) {
            elements[step].spinner.style.display = 'none';
            elements[step].indicator.className = 'step-indicator complete';
            
            try {
                const htmlContent = marked.parse(finalContent);
                elements[step].output.innerHTML = htmlContent;
                elements[step].output.querySelectorAll('pre code').forEach(block => {
                    hljs.highlightElement(block);
                });
            } catch (e) {
                console.error(`Final Markdown parsing failed for ${step}:`, e);
                elements[step].output.textContent = finalContent;
            }
            // Scroll both the content area and the main window to the bottom
            elements[step].output.scrollTop = elements[step].output.scrollHeight;
            scrollToBottom();
        }

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const idea = ideaInput.value.trim();
            if (!idea) {
                alert("Please enter a product idea.");
                return;
            }
            
            submitButton.disabled = true;
            resetUI();

            const eventSource = new EventSource(`/generate?idea=${encodeURIComponent(idea)}`);
            let finalContentBuffer = {};

            eventSource.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'error') {
                        console.error("Server error:", data.error);
                        const errorCard = document.createElement('div');
                        errorCard.className = 'alert alert-danger mt-3';
                        errorCard.textContent = `Error: ${data.error}`;
                        document.getElementById('result-container').appendChild(errorCard);
                        eventSource.close();
                        submitButton.disabled = false;
                        return;
                    }
                    
                    if (data.type === 'status' || data.type === 'status_update') {
                        statusContainer.innerHTML = `<div class="alert alert-info">${data.message}</div>`;
                        scrollToBottom();
                    }
                    else if (data.type === 'step_start') {
                        statusContainer.innerHTML = '';
                        finalContentBuffer[data.step] = '';
                        showStep(data.step);
                        scrollToBottom();
                    }

                    else if (data.type === 'text_chunk') {
                        finalContentBuffer[data.step] += data.content;
                        appendText(data.step, data.content);
                    }

                    else if (data.type === 'step_complete') {
                        completeStep(data.step, data.final_content || finalContentBuffer[data.step]);
                    }

                    else if (data.type === 'complete') {
                        statusContainer.innerHTML = '';
                        eventSource.close();
                        submitButton.disabled = false;
                        const successCard = document.createElement('div');
                        successCard.className = 'alert alert-success mt-3';
                        successCard.innerHTML = '<strong>ðŸŽ‰ Success!</strong> Your MVP has been generated successfully!';
                        document.getElementById('result-container').appendChild(successCard);
                        scrollToBottom();
                    }

                } catch (err) {
                    console.error("Error parsing message:", err, event.data);
                }
            };

            eventSource.onerror = (error) => {
                console.error("EventSource failed:", error);
                eventSource.close();
                statusContainer.innerHTML = '';
                const errorCard = document.createElement('div');
                errorCard.className = 'alert alert-danger mt-3';
                errorCard.textContent = 'Connection error occurred. Please try again.';
                document.getElementById('result-container').appendChild(errorCard);
                submitButton.disabled = false;
                steps.forEach(step => {
                    elements[step].spinner.style.display = 'none';
                });
                scrollToBottom();
            };
        });
    });
</script>
</body>
</html>
